# billing_service

Сервис биллинга для управления платежами, подписками и транзакциями.

## Swagger-документация

[api/v1/billing/openapi](http://127.0.0.1/api/v1/billing/openapi)

## Эндпоинты

### Health Check
- **GET** `/api/v1/billing/health` - Проверка состояния сервиса

### Платежи (Billing)

#### Оплата подписки
- **POST** `/api/v1/billing/payment`
- **Описание**: Оплата подписки пользователем
- **Аутентификация**: JWT или внутренняя
- **Тело запроса**:
```json
{
  "user_id": "123e4567-e89b-12d3-a456-426614174000",
  "subscription_id": "123e4567-e89b-12d3-a456-426614174001"
}
```
- **Ответ**: URL для перенаправления на страницу оплаты

#### Автоплатеж
- **POST** `/api/v1/billing/autopayment`
- **Описание**: Выполнение автоматического платежа
- **Аутентификация**: Только внутренняя
- **Тело запроса**:
```json
{
  "user_subscription_id": "123e4567-e89b-12d3-a456-426614174002"
}
```
- **Ответ**: ID транзакции

#### Возврат средств
- **POST** `/api/v1/billing/refund`
- **Описание**: Возврат средств за платеж
- **Аутентификация**: Только внутренняя
- **Тело запроса**:
```json
{
  "user_id": "123e4567-e89b-12d3-a456-426614174000",
  "transaction_id": "123e4567-e89b-12d3-a456-426614174003",
  "amount": "99.99",
  "currency": "RUB"
}
```
- **Ответ**: Подтверждение успешного возврата

#### Подписка на автоплатежи
- **POST** `/api/v1/billing/autopayment-subscribe`
- **Описание**: Подключение метода автоплатежа
- **Аутентификация**: JWT или внутренняя
- **Тело запроса**:
```json
{
  "user_subscription_id": "123e4567-e89b-12d3-a456-426614174002"
}
```
- **Ответ**: URL для подтверждения метода оплаты

#### Отписка от автоплатежей
- **POST** `/api/v1/billing/autopayment-unsubscribe`
- **Описание**: Отключение метода автоплатежа
- **Аутентификация**: JWT или внутренняя
- **Тело запроса**:
```json
{
  "user_subscription_id": "123e4567-e89b-12d3-a456-426614174002"
}
```
- **Ответ**: Подтверждение успешного отключения

### Информация о подписках (Subs Information)

#### Список подписок
- **GET** `/api/v1/subs_information/subscriptions`
- **Описание**: Получение списка всех подписок с пагинацией
- **Параметры запроса**:
  - `page` (int, ≥1): Номер страницы
  - `size` (int, 1-100): Размер страницы
  - `is_active` (bool, опционально): Фильтр по активности
- **Ответ**:
```json
{
  "total": 100,
  "page": 1,
  "size": 10,
  "items": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174001",
      "role_id": "123e4567-e89b-12d3-a456-426614174004",
      "name": "Premium",
      "description": "Премиум подписка",
      "amount": 999.99,
      "currency": "RUB",
      "period": 30,
      "actual": true,
      "created": "2024-01-01T00:00:00",
      "modified": "2024-01-01T00:00:00"
    }
  ]
}
```

#### Подписки пользователя
- **GET** `/api/v1/subs_information/subscriptions/user/{user_id}`
- **Описание**: Получение списка подписок конкретного пользователя
- **Аутентификация**: JWT или внутренняя
- **Параметры пути**: `user_id` (UUID)
- **Параметры запроса**:
  - `page` (int, ≥1): Номер страницы
  - `size` (int, 1-100): Размер страницы
- **Ответ**:
```json
{
  "total": 5,
  "page": 1,
  "size": 10,
  "items": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174002",
      "created": "2024-01-01T00:00:00",
      "modified": "2024-01-01T00:00:00",
      "user_id": "123e4567-e89b-12d3-a456-426614174000",
      "auto_pay_id": "pay_123456789",
      "subscription_id": "123e4567-e89b-12d3-a456-426614174001",
      "expires": "2024-02-01T00:00:00",
      "subscription": {
        "id": "123e4567-e89b-12d3-a456-426614174001",
        "role_id": "123e4567-e89b-12d3-a456-426614174004",
        "name": "Premium",
        "description": "Премиум подписка",
        "amount": 999.99,
        "currency": "RUB",
        "period": 30,
        "actual": true,
        "created": "2024-01-01T00:00:00",
        "modified": "2024-01-01T00:00:00"
      }
    }
  ]
}
```

#### Транзакции
- **GET** `/api/v1/subs_information/transactions/{user_subscription_id}`
- **Описание**: Получение списка всех транзакций по подписке
- **Аутентификация**: JWT или внутренняя
- **Параметры пути**: `user_subscription_id` (UUID)
- **Ответ**:
```json
{
  "items": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174003",
      "payment_id": "pay_123456789",
      "amount": 999.99,
      "currency": "RUB",
      "status_code": 200,
      "transaction_type": 1,
      "created": "2024-01-01T00:00:00",
      "starts": "2024-01-01T00:00:00",
      "ends": "2024-02-01T00:00:00"
    }
  ]
}
```

### Состояние (State)

#### Информация о платеже
- **GET** `/api/v1/state/payment/{transaction_id}`
- **Описание**: Получение информации о платеже по ID транзакции
- **Аутентификация**: JWT или внутренняя
- **Параметры пути**: `transaction_id` (string)
- **Ответ**: Информация о платеже или 404 если транзакция относится к возврату

#### Информация о возврате
- **GET** `/api/v1/state/refund/{transaction_id}`
- **Описание**: Получение информации о возврате по ID транзакции
- **Аутентификация**: JWT или внутренняя
- **Параметры пути**: `transaction_id` (string)
- **Ответ**: Информация о возврате или 404 если транзакция относится к платежу

#### Информация о методе оплаты
- **GET** `/api/v1/state/payment-method/{transaction_id}`
- **Описание**: Получение информации о методе оплаты по ID транзакции
- **Аутентификация**: JWT или внутренняя
- **Параметры пути**: `transaction_id` (string)
- **Ответ**: Информация о методе оплаты или 404 если не найден

## Аутентификация

Сервис поддерживает два типа аутентификации:
- **JWT токен** - для авторизованных пользователей
- **Внутренняя аутентификация** - для межсервисного взаимодействия
